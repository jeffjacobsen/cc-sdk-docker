services:
  # FastAPI server container
  server:
    container_name: claude-sdk-server
    build:
      context: .
      dockerfile: Dockerfile
    # Tag the built image locally (includes both TypeScript and Python)
    image: ${IMAGE_NAME:-claude-agent-sdk:latest}
    ports:
      - "${PORT:-3000}:${PORT:-3000}"
    environment:
      # CLAUDE_CODE_OAUTH_TOKEN for Claude.ai OAuth tokens
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN:-}
      # Port configuration
      - PORT=${PORT:-3000}
    volumes:
      # Mount current directory for development
      - .:/app
    working_dir: /app
    # Run as root to install packages, then switch to claude user for the server
    user: root
    command: bash -c "pip install -r /app/server/requirements.txt && exec su claude -c 'python /app/server/api.py'"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${PORT:-3000}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

